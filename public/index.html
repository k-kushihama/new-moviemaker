<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTrack v28.0 | Sovereign Edition</title>
    <style>
        :root { --accent: #0A84FF; --bg: #000; --card: rgba(22, 22, 24, 0.7); --border: rgba(255, 255, 255, 0.08); }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 60px 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; min-height: 100vh; background-image: radial-gradient(at 0% 0%, #1a1a1a 0%, #000 100%); }
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; max-width: 1040px; width: 100%; }
        .bento { background: var(--card); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); border-radius: 32px; border: 1px solid var(--border); padding: 32px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        .full { grid-column: span 12; }
        .half-l { grid-column: span 7; }
        .half-r { grid-column: span 5; }
        h1 { font-size: 48px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .preview { position: relative; aspect-ratio: 16/9; background: #050505; border-radius: 24px; overflow: hidden; border: 1px solid var(--border); }
        #wm { position: absolute; transform: translate(-50%, -50%); cursor: grab; font-weight: 700; color: #fff; text-shadow: 0 2px 12px rgba(0,0,0,1); white-space: nowrap; width: max-content; }
        .input-box { margin-bottom: 24px; }
        label { display: block; font-size: 11px; color: #666; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
        input[type="text"], input[type="number"] { width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 16px; padding: 18px; color: #fff; outline: none; box-sizing: border-box; font-size: 16px; }
        .file-row { background: rgba(255,255,255,0.04); padding: 18px; border-radius: 18px; display: flex; justify-content: space-between; margin-bottom: 12px; cursor: pointer; border: 1px solid var(--border); transition: 0.3s; }
        .file-row:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); }
        .btn { background: var(--accent); color: #fff; border: none; padding: 24px; width: 100%; border-radius: 20px; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 15px 35px rgba(10, 132, 255, 0.3); transition: 0.3s; }
        .btn:disabled { opacity: 0.3; filter: grayscale(1); }
        .prog-ui { margin-top: 24px; display: none; }
        .track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        .info { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 12px; font-weight: 600; }
        .result-area { display: none; margin-top: 32px; animation: fadeInUp 0.8s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        video { width: 100%; border-radius: 28px; border: 1px solid var(--border); box-shadow: 0 40px 80px rgba(0,0,0,0.6); }
        .download-link { display: inline-block; margin-top: 20px; color: var(--accent); text-decoration: none; font-weight: 700; font-size: 14px; border: 1px solid var(--accent); padding: 12px 24px; border-radius: 12px; transition: 0.3s; }
        .download-link:hover { background: var(--accent); color: #fff; }
    </style>
</head>
<body>

<div class="grid">
    <header class="full" style="margin-bottom:20px;">
        <h1>SnapTrack</h1>
        <p style="color:#555; letter-spacing:0.3em; font-size:11px; margin-top:8px;">SOVEREIGN ENGINE V28.0</p>
    </header>

    <div class="bento full preview" id="stage"><div id="wm">SnapTrack</div></div>

    <div class="bento half-l">
        <div class="input-box"><label>Watermark Label</label><input type="text" id="wt" value="SnapTrack"></div>
        <div class="input-box"><label>Color & Size</label><div style="display:flex; gap:15px;"><input type="color" id="wc" value="#ffffff" style="width:60px; height:50px; border:none; background:none;"><input type="range" id="ws" min="16" max="150" value="32" style="flex:1;"></div></div>
        <div class="file-row" onclick="document.getElementById('v').click()"><strong>Video</strong><span id="vn" style="font-size:12px;color:#666;">Select File</span><input type="file" id="v" accept="video/mp4" hidden></div>
        <div class="file-row" onclick="document.getElementById('a').click()"><strong>Audio</strong><span id="an" style="font-size:12px;color:#666;">Select File</span><input type="file" id="a" accept="audio/*" hidden></div>
    </div>

    <div class="bento half-r" style="display:flex; flex-direction:column; justify-content:space-between;">
        <div>
            <div class="input-box"><label>Trim Start (sec)</label><input type="number" id="ts" placeholder="0.0"></div>
            <div class="input-box"><label>Trim End (sec)</label><input type="number" id="te" placeholder="Full Length"></div>
        </div>
        <div>
            <button id="go" class="btn">EXECUTE MASTER RENDER</button>
            <div class="prog-ui" id="pg">
                <div class="track"><div class="bar" id="bf"></div></div>
                <div class="info"><span id="stat">Standby</span><span id="eta">ETA: --s</span></div>
            </div>
        </div>
    </div>

    <div class="bento full result-area" id="res">
        <h3 style="margin-top:0;">Master Rendered Video</h3>
        <video id="out" controls playsinline></video>
        <a id="dl" class="download-link" download="SnapTrack_Export.mp4">DOWNLOAD MASTER FILE</a>
    </div>
</div>

<script>
    const wm = document.getElementById('wm'), stage = document.getElementById('stage'), wt = document.getElementById('wt'), ws = document.getElementById('ws'), wc = document.getElementById('wc'), ts = document.getElementById('ts'), te = document.getElementById('te');
    let x = 50, y = 80, s = 32;

    const save = (k, v) => document.cookie = `${k}=${encodeURIComponent(v)}; max-age=31536000; path=/`;
    const get = (k) => document.cookie.match(new RegExp(`(?:^|; )${k}=([^;]*)`))?.[1];

    window.onload = () => {
        if(get('x')) { x = parseFloat(get('x')); wm.style.left = x + '%'; }
        if(get('y')) { y = parseFloat(get('y')); wm.style.top = y + '%'; }
        if(get('s')) { s = parseInt(get('s')); ws.value = s; wm.style.fontSize = s + 'px'; }
        if(get('c')) { wm.style.color = decodeURIComponent(get('c')); wc.value = decodeURIComponent(get('c')); }
        if(get('t')) { const val = decodeURIComponent(get('t')); wt.value = val; wm.innerText = val; }
    };

    wt.oninput = () => { wm.innerText = wt.value; save('t', wt.value); };
    ws.oninput = () => { s = ws.value; wm.style.fontSize = s + 'px'; save('s', s); };
    wc.oninput = () => { wm.style.color = wc.value; save('c', wc.value); };

    const handleDrag = (e) => {
        e.preventDefault();
        const r = stage.getBoundingClientRect();
        const move = (ev) => {
            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX, cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
            x = Math.max(0, Math.min(100, ((cx - r.left) / r.width) * 100));
            y = Math.max(0, Math.min(100, ((cy - r.top) / r.height) * 100));
            wm.style.left = x + '%'; wm.style.top = y + '%';
        };
        const end = () => { save('x', x); save('y', y); document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end); };
        document.addEventListener('mousemove', move); document.addEventListener('mouseup', end); document.addEventListener('touchmove', move, {passive:false}); document.addEventListener('touchend', end);
    };
    wm.addEventListener('mousedown', handleDrag); wm.addEventListener('touchstart', handleDrag, {passive:false});

    const uploadChunks = async (file, onProgress) => {
        const CHUNK = 5 * 1024 * 1024;
        const total = Math.ceil(file.size / CHUNK);
        const fname = `${Date.now()}_${file.name}`;
        for (let i = 0; i < total; i++) {
            const chunk = file.slice(i * CHUNK, Math.min(file.size, (i + 1) * CHUNK));
            const fd = new FormData();
            fd.append('chunk', chunk); fd.append('filename', fname); fd.append('chunkIndex', i);
            await fetch('/upload-chunk', { method: 'POST', body: fd });
            onProgress(Math.round(((i + 1) / total) * 100));
        }
        return fname;
    };

    document.getElementById('v').onchange = e => document.getElementById('vn').innerText = e.target.files[0]?.name;
    document.getElementById('a').onchange = e => document.getElementById('an').innerText = e.target.files[0]?.name;

    document.getElementById('go').onclick = async () => {
        const vf = document.getElementById('v').files[0], af = document.getElementById('a').files[0];
        if(!vf || !af) return alert("Select files.");
        const btn = document.getElementById('go'), pui = document.getElementById('pg'), bar = document.getElementById('bf'), stat = document.getElementById('stat'), eta = document.getElementById('eta');
        btn.disabled = true; pui.style.display = 'block';

        try {
            stat.innerText = "UPLOADING...";
            const vName = await uploadChunks(vf, p => bar.style.width = p + '%');
            const aName = await uploadChunks(af, p => bar.style.width = p + '%');

            stat.innerText = "INITIATING RENDER...";
            const res = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    videoName: vName, audioName: aName, wm: wt.value,
                    x, y, fontsize: s, color: wc.value,
                    start: ts.value || 0, end: te.value || 0
                })
            });
            const { jobId } = await res.json();

            const timer = setInterval(async () => {
                const pr = await fetch(`/progress/${jobId}`);
                const data = await pr.json();
                bar.style.width = data.progress + '%';
                eta.innerText = `ETA: ${data.eta}S`;
                stat.innerText = `RENDERING: ${data.progress}%`;

                if (data.status === 'completed') {
                    clearInterval(timer);
                    stat.innerText = "MASTER RENDER COMPLETE";
                    btn.disabled = false;
                    
                    // リロードせずにUIを表示
                    const resArea = document.getElementById('res');
                    const video = document.getElementById('out');
                    const dl = document.getElementById('dl');
                    
                    const finalUrl = data.url + '?t=' + Date.now();
                    video.src = finalUrl;
                    dl.href = finalUrl;
                    resArea.style.display = 'block';
                    
                    // スムーズにスクロール
                    resArea.scrollIntoView({ behavior: 'smooth' });
                }
            }, 1000);
        } catch(e) { alert("Network Error."); btn.disabled = false; }
    };
</script>
</body>
</html>