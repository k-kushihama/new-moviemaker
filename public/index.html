<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTrack v27.0 | Enterprise Engine</title>
    <style>
        :root { --accent: #0A84FF; --bg: #000; --card: rgba(22, 22, 24, 0.8); --border: rgba(255, 255, 255, 0.1); }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 60px 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; min-height: 100vh; background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 100%); }
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; max-width: 1000px; width: 100%; }
        .bento { background: var(--card); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-radius: 32px; border: 1px solid var(--border); padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .full { grid-column: span 12; }
        .half-l { grid-column: span 7; }
        .half-r { grid-column: span 5; }
        .preview { position: relative; aspect-ratio: 16/9; background: #000; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); }
        #wm { position: absolute; transform: translate(-50%, -50%); cursor: grab; font-weight: 700; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.9); white-space: nowrap; width: max-content; }
        .input-box { margin-bottom: 20px; }
        label { display: block; font-size: 11px; color: #555; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; }
        input[type="text"], input[type="number"] { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 14px; padding: 15px; color: #fff; outline: none; }
        .file-row { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 16px; display: flex; justify-content: space-between; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border); }
        .btn { background: var(--accent); color: #fff; border: none; padding: 22px; width: 100%; border-radius: 20px; font-size: 18px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn:disabled { opacity: 0.4; filter: grayscale(1); }
        .prog-ui { margin-top: 20px; display: none; }
        .track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        .info { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 10px; }
        video { width: 100%; border-radius: 24px; margin-top: 20px; display: none; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="grid">
    <header class="full">
        <h1 style="font-size:42px; margin:0; letter-spacing:-2px;">SnapTrack</h1>
        <p style="color:#555; letter-spacing:0.2em; font-size:11px; margin:10px 0 30px;">GLOBAL ENTERPRISE V27</p>
    </header>

    <div class="bento full preview" id="stage"><div id="wm">SnapTrack</div></div>

    <div class="bento half-l">
        <div class="input-box"><label>Watermark Text</label><input type="text" id="wt" value="SnapTrack"></div>
        <div class="input-box"><label>Color & Size</label><div style="display:flex; gap:15px;"><input type="color" id="wc" value="#ffffff" style="width:60px; height:48px; border:none; background:none;"><input type="range" id="ws" min="16" max="150" value="32" style="flex:1;"></div></div>
        <div class="file-row" onclick="document.getElementById('v').click()"><strong>Video</strong><span id="vn">Select File</span><input type="file" id="v" accept="video/mp4" hidden></div>
        <div class="file-row" onclick="document.getElementById('a').click()"><strong>Audio</strong><span id="an">Select File</span><input type="file" id="a" accept="audio/*" hidden></div>
    </div>

    <div class="bento half-r" style="display:flex; flex-direction:column; justify-content:space-between;">
        <div>
            <div class="input-box"><label>Trim Start (s)</label><input type="number" id="ts" placeholder="0.0"></div>
            <div class="input-box"><label>Trim End (s)</label><input type="number" id="te" placeholder="Full"></div>
        </div>
        <div>
            <button id="go" class="btn">EXECUTE MASTER RENDER</button>
            <div class="prog-ui" id="pg">
                <div class="track"><div class="bar" id="bf"></div></div>
                <div class="info"><span id="stat">Standby</span><span id="eta">ETA: --s</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    const wm = document.getElementById('wm'), stage = document.getElementById('stage'), wt = document.getElementById('wt'), ws = document.getElementById('ws'), wc = document.getElementById('wc'), ts = document.getElementById('ts'), te = document.getElementById('te');
    let x = 50, y = 80, s = 32;

    const save = (k, v) => document.cookie = `${k}=${encodeURIComponent(v)}; max-age=31536000; path=/`;
    const get = (k) => document.cookie.match(new RegExp(`(?:^|; )${k}=([^;]*)`))?.[1];

    window.onload = () => {
        if(get('x')) { x = parseFloat(get('x')); wm.style.left = x + '%'; }
        if(get('y')) { y = parseFloat(get('y')); wm.style.top = y + '%'; }
        if(get('s')) { s = parseInt(get('s')); ws.value = s; wm.style.fontSize = s + 'px'; }
        if(get('c')) { wm.style.color = decodeURIComponent(get('c')); wc.value = decodeURIComponent(get('c')); }
        if(get('t')) { const val = decodeURIComponent(get('t')); wt.value = val; wm.innerText = val; }
    };

    wt.oninput = () => { wm.innerText = wt.value; save('t', wt.value); };
    ws.oninput = () => { s = ws.value; wm.style.fontSize = s + 'px'; save('s', s); };
    wc.oninput = () => { wm.style.color = wc.value; save('c', wc.value); };

    const handleDrag = (e) => {
        e.preventDefault();
        const r = stage.getBoundingClientRect();
        const move = (ev) => {
            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX, cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
            x = Math.max(0, Math.min(100, ((cx - r.left) / r.width) * 100));
            y = Math.max(0, Math.min(100, ((cy - r.top) / r.height) * 100));
            wm.style.left = x + '%'; wm.style.top = y + '%';
        };
        const end = () => { save('x', x); save('y', y); document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end); };
        document.addEventListener('mousemove', move); document.addEventListener('mouseup', end); document.addEventListener('touchmove', move, {passive:false}); document.addEventListener('touchend', end);
    };
    wm.addEventListener('mousedown', handleDrag); wm.addEventListener('touchstart', handleDrag, {passive:false});

    const uploadInChunks = async (file, onProgress) => {
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB chunks (Cloudflare friendly)
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        const filename = `${Date.now()}_${file.name}`;

        for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK_SIZE;
            const end = Math.min(file.size, start + CHUNK_SIZE);
            const chunk = file.slice(start, end);

            const fd = new FormData();
            fd.append('chunk', chunk);
            fd.append('filename', filename);
            fd.append('chunkIndex', i);

            await fetch('/upload-chunk', { method: 'POST', body: fd });
            onProgress(Math.round(((i + 1) / totalChunks) * 100));
        }
        return filename;
    };

    document.getElementById('v').onchange = e => document.getElementById('vn').innerText = e.target.files[0]?.name;
    document.getElementById('a').onchange = e => document.getElementById('an').innerText = e.target.files[0]?.name;

    document.getElementById('go').onclick = async () => {
        const vf = document.getElementById('v').files[0], af = document.getElementById('a').files[0];
        if(!vf || !af) return alert("Select files.");
        
        const btn = document.getElementById('go'), pui = document.getElementById('pg'), bar = document.getElementById('bf'), stat = document.getElementById('stat'), eta = document.getElementById('eta');
        btn.disabled = true; pui.style.display = 'block';

        try {
            stat.innerText = "UPLOADING VIDEO...";
            const vName = await uploadInChunks(vf, p => bar.style.width = p + '%');
            stat.innerText = "UPLOADING AUDIO...";
            const aName = await uploadInChunks(af, p => bar.style.width = p + '%');

            stat.innerText = "INITIATING RENDER...";
            const res = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    videoName: vName, audioName: aName, wm: wt.value,
                    x, y, fontsize: s, color: wc.value,
                    start: ts.value || 0, end: te.value || 0
                })
            });
            const { jobId } = await res.json();

            const timer = setInterval(async () => {
                const pr = await fetch(`/progress/${jobId}`);
                const data = await pr.json();
                bar.style.width = data.progress + '%';
                eta.innerText = `ETA: ${data.eta}S`;
                stat.innerText = `RENDERING: ${data.progress}%`;

                if (data.status === 'completed') {
                    clearInterval(timer);
                    stat.innerText = "COMPLETE";
                    btn.disabled = false;
                    window.location.reload(); // 再リロードして動画を表示（またはvideo.src更新）
                }
            }, 1000);
        } catch(e) { alert("Error during transfer."); btn.disabled = false; }
    };
</script>
</body>
</html>